---
title: "TreeViz-basics"
author: "Jayaram Kancherla, Hector Corrada Bravo"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Introduction to TreeViz}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## loading required packages

```{r load-packages, message=FALSE, warning=FALSE}
library(palmtree)
library(clustree)
library(Seurat)
library(SingleCellExperiment)
```

## Example Data

```{r}
data("sc_example")
hierarchy <- sc_example$sc3_clusters
```


## creating a `TreeViz` object

```{r} 
treeviz <- createTreeViz(sc_example$sc3_clusters, sc_example$counts)
tree <- TreeIndex(hierarchy )


treeviz
```


## Operations on TreeViz objects

`TreeViz` provides `aggregateTree` method, to aggregate counts (rows or columns) to a given tree selection. The result is a `TreeViz` object.

```{r}
aggr <- aggregateTree(treeviz, selectedLevel=3, by="col")
aggr
```

### Defining a cut in the tree

In the previous example, we use the `selectedLevel` parameter to aggregate counts at level 3. 
We also provide another parameter `selectedNodes` to allow users specify nodes for aggregating the tree. 
using this parameter, we can perform aggregations at different levels of the tree.

Note: A `facetZoom` visualization from `metavizr` will help make node selections easier.

```{r}
# lets get the list of all nodes from the tree
nodes <- getNodes(tree)

# select/remove rows in data frame to only keep nodes to aggregate 
# this example chooses all level 3 nodes and two nodes from level 4 (Bacillales and Lactobacillales) 
# to define the node selection. The dataframe can also be filtered by name and lineage.
nodes <- nodes[level %in% c(3,4),][1:19]

# aggregate counts to node selection
agg_sel <- aggregateTree(treeviz, selectedLevel=3, selectedNodes=nodes, by="col")
agg_sel
```


